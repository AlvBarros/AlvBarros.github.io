<html>
    <head>
        <!-- LEAFLET -->
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.5.1/dist/leaflet.css"
        integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
        crossorigin=""/>
        <script src="https://unpkg.com/leaflet@1.5.1/dist/leaflet.js"
        integrity="sha512-GffPMF3RvMeYyc1LWMHtK8EbPv0iNZ8/oTtHPx9/cc2ILxQ+u905qIwdpULaqDkyBKgOaB57QTMg7ztg8Jm2Og=="
        crossorigin=""></script>
        <!-- </> -->

        <!-- MAP BOX -->
        <script src='https://api.mapbox.com/mapbox-gl-js/v1.4.1/mapbox-gl.js'></script>
        <link href='https://api.mapbox.com/mapbox-gl-js/v1.4.1/mapbox-gl.css' rel='stylesheet' />
        <!-- </> -->
        <style>
        #mapid {
            height: 600px;
            width: 800px;
            margin: auto;
            display: block;
        }
        </style>

		<script src='https://cdnjs.cloudflare.com/ajax/libs/leaflet-routing-machine/3.2.5/leaflet-routing-machine.js'></script>
		<link href='https://cdnjs.cloudflare.com/ajax/libs/leaflet-routing-machine/3.2.5/leaflet-routing-machine.css' rel='stylesheet' />

		<script src='https://cdnjs.cloudflare.com/ajax/libs/perliedman-leaflet-control-geocoder/1.5.5/Control.Geocoder.min.js'></script>
		<link href='https://cdnjs.cloudflare.com/ajax/libs/perliedman-leaflet-control-geocoder/1.5.5/Control.Geocoder.min.css' rel='stylesheet' />
    </head>
    <body>
        <div id="mapid"></div>
		<input type="button" id="calcular" value="Calcular"/>
    </body>
    <script>
        const locations = [];
		navigator.geolocation.getCurrentPosition((pos) => {
			var mymap = L.map('mapid').setView([pos.coords.latitude, pos.coords.longitude], 13);
        
			mapboxgl.accessToken = 'pk.eyJ1IjoiYWx2YiIsImEiOiJjanRkazRlNW4wZHZwNDZwN3FmNHJ2NDQ3In0.FiOFxgQ3B-X6QFwUAEYJbw';
			
			L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}', {
				attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
				maxZoom: 18,
				id: 'mapbox.streets',
				accessToken: mapboxgl.accessToken
			}).addTo(mymap);

			const popup = L.popup();
			const marker = L.marker;
			
			function onMapClick(e) {
				if (locations.filter((coords) => {
					coords[0] == e.latlng.lat && coords[1] == e.latlng.lng
					var diffLat = (e.latlng.lat - coords[0]);
					var diffLng = (e.latlng.lng - coords[1]);
					if (diffLat < 0) diffLat = diffLat * -1;
					if (diffLng < 0) diffLng = diffLng * -1;
					return diffLat < 0.001 && diffLng < 0.001; 
				}).length == 0) {
					locations.push([e.latlng.lat, e.latlng.lng]);
					var layer = L.marker([e.latlng.lat, e.latlng.lng]).addTo(mymap);
					layer.on('click', () => { layer.remove(); });
					<!-- console.log(`${locations.length} added.`); -->
				}
			}

			mymap.on("click", onMapClick);
			
			document.getElementById("calcular").addEventListener("click", () => {
				console.log(`Calculating Dijkstra on ${locations.length} locations.`);

				let request = new XMLHttpRequest();

				request.open('POST', "https://api.openrouteservice.org/v2/directions/driving-car");

				request.setRequestHeader('Accept', 'application/json, application/geo+json, application/gpx+xml, img/png; charset=utf-8');
				request.setRequestHeader('Content-Type', 'application/json');
				request.setRequestHeader('Authorization', '5b3ce3597851110001cf624883561aed03e04c899ca39553fd0001e3');

				request.onreadystatechange = function () {
					if (this.readyState === 4) {
						console.log('Status:', this.status);
						console.log('Headers:', this.getAllResponseHeaders());
						console.log('Body:', this.responseText);
					}
					var control = L.Routing.control({
					  waypoints: [
						L.latLng(locations[0][0], locations[0][1]),
						L.latLng(locations[1][0], locations[1][1])
					  ],
					  router: new L.Routing.osrmv1({
						language: 'en',
						profile: 'car'
					  }),
					  geocoder: L.Control.Geocoder.nominatim({})
					}).addTo(mymap);
					// https://gis.stackexchange.com/questions/323310/leaflet-routing-machine-get-route-summary-without-drawind-route
				};

				const body = '{"coordinates":[[8.681495,49.41461],[8.686507,49.41943],[8.687872,49.420318]]}';

				request.send(body);
			});
		});
    </script>
</html>